<!DOCTYPE html>
<html>
<head></head>
<body>
    <h1>HCA decoder demo</h1>
    <hr>
    <h3>Choose a HCA file</h3>
    key1=<input type="text" spellcheck="false" id="key1input" value="0x01395C51"><br>
    key2=<input type="text" spellcheck="false" id="key2input" value="0x00000000"><br>
    <i>Note: decryption process will be skipped if the HCA is not encrypted.</i><br>
    <input type="file" id="hcainput" accept=".hca" onchange="handleFile(this.files)"><br>
    Or <button id="downloadbtn" onclick="download()">download</button> from URL: <input type="text" spellcheck="false" id="urlinput" value="bgm01_anime02_hca.hca"><br>
    <hr>
    <!--
    <h3>Streamed decoding & play (through <i>experimental</i> Media Source Extensions API)</h3>
    <input type="checkbox" id="loopflaginput" checked label="looplabel"><label for="looplabel">Loop</label><br>
    <button disabled id="playbtn" onclick="play()">Play</button><br>
    <audio id="stream_audio" controls></audio><br>
    <br>
    <hr>
    -->
    <h3>Decode the whole file</h3>
    (Extra) loop count: <input type="number" step="1" min="0" max="99" placeholder="0-99" id="loopcountinput" value="0"><br>
    <i>Note: loop count is ignored if HCA header doesn't have loop section</i><br>
    <button disabled id="decodeinworkerbtn" onclick="decodeWholeInWorker()">Decode (in background)</button><br>
    <audio id="whole_audio" controls></audio><br>
    <!-- <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.8.3/dist/ffmpeg.min.js"></script> -->
    <script src="hca.js"></script>
    <script>
        var hcabuf = null;

        var decodeinworkerbtn = document.getElementById("decodeinworkerbtn");
        var downloadbtn = document.getElementById("downloadbtn");

        var ctrlbtns = [decodeinworkerbtn];

        function handleFile(files) {
            hcabuf = null;
            recycleObjURLs();
            if (files.length == 1) files[0].arrayBuffer().then((ab) => hcabuf = ab);
            ctrlbtns.forEach(btn => btn.disabled = files.length != 1);
            downloadbtn.textContent = "download";
        }

        function download() {
            downloadbtn.disabled = true;
            downloadbtn.textContent = "downloading...";
            hcabuf = null;
            recycleObjURLs();
            ctrlbtns.forEach(btn => btn.disabled = true);
            let url = document.getElementById("urlinput").value;
            if (url !== "") fetch(url).then((res) => {
                if (res.status == 200) {
                    res.arrayBuffer().then((ab) => {
                        hcabuf = ab;
                        ctrlbtns.forEach(btn => btn.disabled = false);
                        downloadbtn.textContent = "download (successful)";
                        downloadbtn.disabled = false;
                    });
                } else throw "download failed, status " + res.status;
            }).catch((e) => {
                console.error(e);
                downloadbtn.textContent = "download (failed)";
                downloadbtn.disabled = false;
            });
        }

        /*
        var audioCtx = null;
        function play() {
            if (!audioCtx) {
                let AudioContext = window.AudioContext;// || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }

            let key1 = document.getElementById("key1input").value;
            let key2 = document.getElementById("key2input").value;
            let loopFlag = document.getElementById("loopflaginput").checked;
            hca.play(new Uint8Array(hcabuf), loopFlag, audioCtx);
            console.log("Started playing");
        }
        */

        const donwHCAIds = ["decryptedHCALink", "originHCALink"];
        function recycleObjURLs() {
            if (whole_audio.src !== "") URL.revokeObjectURL(whole_audio.src);
            whole_audio.src = "";
            donwHCAIds.forEach((id) => {
                let a = document.getElementById(id);
                if (a != null) {
                    if (a.nextSibling && a.nextSibling.tagName.toLowerCase() === "br") a.nextSibling.remove();
                    URL.revokeObjectURL(a.getAttribute("href"));
                    a.remove();
                }
            });
        }
        function decodeWholeInWorker() {
            recycleObjURLs();
            decodeinworkerbtn.disabled = true;
            let key1 = document.getElementById("key1input").value;
            let key2 = document.getElementById("key2input").value;
            let loop = parseInt(document.getElementById("loopcountinput").value);
            if (isNaN(loop) || loop < 0 || loop > 99) {
                loop = 0;
                document.getElementById("loopcountinput").value = 0;
            }
            let hcaworker = new Worker('hca.js');
            let hcaworkerctrl = new HCAWorkerCtrl(hcaworker, () => {decodeinworkerbtn.disabled = false;}, key1, key2);
            hcaworkerctrl.tick();
            hcaworkerctrl.load(new Uint8Array(hcabuf));
            hcaworkerctrl.tock("load & decrypt");
            hcaworkerctrl.tick();
            hcaworkerctrl.decode(undefined, 16, loop, 1.0);
            hcaworkerctrl.tock("decode");
            hcaworkerctrl.tick();
            hcaworkerctrl.getData(["isWholeHCAEncrypted", "origin", "decrypted", "wholeDecodedWAV"], (result) => {
                whole_audio.src = URL.createObjectURL(new Blob([result.wholeDecodedWAV], {type : 'audio/x-wav'}));
                donwHCAIds.forEach((id) => {
                    if (id === "decryptedHCALink" && !result.isWholeHCAEncrypted) return;
                    let a = document.createElement("a");
                    a.setAttribute("id", id);
                    a.setAttribute("download", id.replace("HCALink", ".hca"));
                    a.setAttribute("href", URL.createObjectURL(new Blob([result[id.replace("HCALink", "")]], {type : 'application/octet-stream'})));
                    a.innerHTML = id.replace("HCALink", " HCA");
                    let refNode = whole_audio.nextSibling;
                    document.body.insertBefore(document.createElement("br"), refNode);
                    document.body.insertBefore(a, refNode);
                });
                decodeinworkerbtn.disabled = false;
            });
            hcaworkerctrl.tock("getData");
            hcaworkerctrl.shutdown();
        }
    </script>
</body>
</html>